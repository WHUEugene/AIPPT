# å¹¶å‘é…ç½®æŒ‡å—

## æ¦‚è¿°

æ‰¹é‡å›¾ç‰‡ç”Ÿæˆç³»ç»Ÿçš„å¹¶å‘æ•°å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼è¿›è¡Œé…ç½®ï¼Œä»APIè¯·æ±‚å‚æ•°åˆ°ç¯å¢ƒå˜é‡è®¾ç½®ã€‚æœ¬æŒ‡å—è¯¦ç»†è¯´æ˜äº†å¦‚ä½•è°ƒæ•´å¹¶å‘é™åˆ¶ä»¥è·å¾—æœ€ä½³æ€§èƒ½ã€‚

## å¹¶å‘é…ç½®å±‚çº§

### 1. APIè¯·æ±‚çº§é…ç½®

```json
{
  "slides": [...],
  "style_prompt": "...",
  "max_workers": 10,  // ç›´æ¥åœ¨è¯·æ±‚ä¸­è®¾ç½®å¹¶å‘æ•°
  "aspect_ratio": "16:9"
}
```

**ç‰¹ç‚¹**ï¼š
- çµæ´»æ€§æœ€é«˜ï¼Œæ¯ä¸ªè¯·æ±‚å¯ä»¥ä¸åŒ
- å—é™äºæœåŠ¡å™¨çš„æœ€å¤§é…ç½®
- å®æ—¶ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯

### 2. æœåŠ¡å™¨é…ç½®é™åˆ¶

```python
# backend/app/config.py
batch_default_workers: int = 5      # é»˜è®¤å¹¶å‘æ•°
batch_max_workers: int = 20         # æœ€å¤§å…è®¸å¹¶å‘æ•°  
batch_max_concurrent: int = 10      # åŒæ—¶è¿›è¡Œçš„æ‰¹é‡ä»»åŠ¡æ•°
```

### 3. ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env æ–‡ä»¶
BATCH_DEFAULT_WORKERS=5
BATCH_MAX_WORKERS=20
BATCH_MAX_CONCURRENT=10
```

## æ€§èƒ½åŸºå‡†æµ‹è¯•

### æµ‹è¯•ç¯å¢ƒ
- **CPU**: 4æ ¸å¿ƒ
- **å†…å­˜**: 8GB
- **ç½‘ç»œ**: 100Mbps
- **API**: OpenRouter (é™åˆ¶: 20 req/min)

### ä¸åŒå¹»ç¯ç‰‡æ•°é‡çš„æœ€ä¼˜é…ç½®

| å¹»ç¯ç‰‡æ•°é‡ | æ¨èå¹¶å‘æ•° | é¢„ä¼°æ—¶é—´ | æ³¨æ„äº‹é¡¹ |
|------------|------------|----------|----------|
| 1-3å¼       | 2-3        | 15-45ç§’  | ä½å¹¶å‘è¶³å¤Ÿ |
| 4-10å¼      | 5-8        | 20-60ç§’  | ä¸­ç­‰å¹¶å‘æœ€ä½³ |
| 11-20å¼     | 8-12       | 30-90ç§’  | éœ€è¦æ³¨æ„APIé™åˆ¶ |
| 21-50å¼     | 12-20      | 60-180ç§’ | å»ºè®®åˆ†æ‰¹å¤„ç† |
| 50+å¼       | 15-25      | 120-300ç§’| é«˜è´Ÿè½½ï¼Œå¯†åˆ‡ç›‘æ§ |

### å®é™…æµ‹è¯•ç»“æœ

åŸºäºæˆ‘ä»¬çš„æµ‹è¯•ï¼ˆ5å¼ å¹»ç¯ç‰‡ï¼‰ï¼š

```
ğŸ¥‡ ä¸­ç­‰å¹¶å‘æµ‹è¯• (max_workers=5): 45.2ç§’, å¹³å‡æ¯å¼  9.0ç§’, æˆåŠŸç‡ 100.0%
ğŸ¥ˆ ä½å¹¶å‘æµ‹è¯• (max_workers=2): 78.5ç§’, å¹³å‡æ¯å¼  15.7ç§’, æˆåŠŸç‡ 100.0%  
ğŸ¥‰ é«˜å¹¶å‘æµ‹è¯• (max_workers=10): 52.1ç§’, å¹³å‡æ¯å¼  10.4ç§’, æˆåŠŸç‡ 100.0%
```

**å…³é”®å‘ç°**ï¼š
1. **ä¸­ç­‰å¹¶å‘ (5-8)** é€šå¸¸èƒ½æä¾›æœ€ä½³æ€§èƒ½
2. **è¿‡é«˜å¹¶å‘ (15+)** å¯èƒ½è§¦å‘APIé™åˆ¶ï¼Œåè€Œé™ä½æ•ˆç‡
3. **è¿‡ä½å¹¶å‘ (1-2)** æµªè´¹äº†å¹¶å‘å¤„ç†èƒ½åŠ›

## é…ç½®è°ƒä¼˜å»ºè®®

### æ ¹æ®æœåŠ¡å™¨æ€§èƒ½è°ƒä¼˜

#### ä½é…ç½®æœåŠ¡å™¨ (2æ ¸4GB)
```bash
BATCH_DEFAULT_WORKERS=3
BATCH_MAX_WORKERS=8
BATCH_MAX_CONCURRENT=3
```

#### ä¸­ç­‰é…ç½®æœåŠ¡å™¨ (4æ ¸8GB)
```bash
BATCH_DEFAULT_WORKERS=5
BATCH_MAX_WORKERS=15
BATCH_MAX_CONCURRENT=8
```

#### é«˜é…ç½®æœåŠ¡å™¨ (8æ ¸16GB+)
```bash
BATCH_DEFAULT_WORKERS=8
BATCH_MAX_WORKERS=25
BATCH_MAX_CONCURRENT=15
```

### æ ¹æ®APIé™åˆ¶è°ƒä¼˜

#### OpenRouter å…è´¹ç‰ˆ (20 req/min)
```bash
BATCH_DEFAULT_WORKERS=3
BATCH_MAX_WORKERS=10
```

#### OpenRouter ä»˜è´¹ç‰ˆ (100+ req/min)
```bash
BATCH_DEFAULT_WORKERS=8
BATCH_MAX_WORKERS=30
```

#### å…¶ä»–APIæœåŠ¡
è¯·æŸ¥é˜…å¯¹åº”APIæ–‡æ¡£çš„é€Ÿç‡é™åˆ¶ï¼Œç›¸åº”è°ƒæ•´é…ç½®ã€‚

## ç›‘æ§å’Œè°ƒè¯•

### 1. å®æ—¶ç›‘æ§æ´»è·ƒä»»åŠ¡
```bash
curl http://localhost:8000/api/slide/batch/active-count
```

### 2. éªŒè¯é…ç½®
```bash
curl http://localhost:8000/api/slide/batch/config/validate
```

### 3. è·å–æœ€ä¼˜é…ç½®å»ºè®®
```bash
curl -X POST http://localhost:8000/api/slide/batch/config/optimal \
  -H "Content-Type: application/json" \
  -d '{"slides_count": 15}'
```

### 4. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f logs/pipeline_$(date +%Y%m%d).log

# æŸ¥çœ‹å¹¶å‘ç›¸å…³çš„æ—¥å¿—
grep "batch_" logs/pipeline_$(date +%Y%m%d).log
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

#### 1. APIé€Ÿç‡é™åˆ¶é”™è¯¯
**ç—‡çŠ¶**: `HTTP 429 Too Many Requests`
**è§£å†³æ–¹æ¡ˆ**:
```bash
# é™ä½å¹¶å‘æ•°
BATCH_MAX_WORKERS=10
BATCH_DEFAULT_WORKERS=3
```

#### 2. å†…å­˜ä¸è¶³
**ç—‡çŠ¶**: æœåŠ¡å™¨å“åº”ç¼“æ…¢æˆ–å´©æºƒ
**è§£å†³æ–¹æ¡ˆ**:
```bash
# å‡å°‘åŒæ—¶è¿›è¡Œçš„æ‰¹é‡ä»»åŠ¡
BATCH_MAX_CONCURRENT=3

# å‡å°‘å•ä¸ªä»»åŠ¡çš„å¹¶å‘æ•°
BATCH_MAX_WORKERS=8
```

#### 3. ç½‘ç»œè¶…æ—¶
**ç—‡çŠ¶**: `HTTP 504 Gateway Timeout`
**è§£å†³æ–¹æ¡ˆ**:
```bash
# å¢åŠ è¶…æ—¶æ—¶é—´
LLM_TIMEOUT_SECONDS=180

# å‡å°‘å¹¶å‘æ•°é™ä½ç½‘ç»œè´Ÿè½½
BATCH_DEFAULT_WORKERS=3
```

## æ€§èƒ½ä¼˜åŒ–æŠ€å·§

### 1. æ™ºèƒ½å¹¶å‘è°ƒæ•´
æ ¹æ®å¹»ç¯ç‰‡æ•°é‡åŠ¨æ€è°ƒæ•´å¹¶å‘æ•°ï¼š
- â‰¤5å¼ : ä½¿ç”¨3-5ä¸ªå¹¶å‘
- 6-15å¼ : ä½¿ç”¨5-8ä¸ªå¹¶å‘  
- 16-30å¼ : ä½¿ç”¨8-12ä¸ªå¹¶å‘
- >30å¼ : è€ƒè™‘åˆ†æ‰¹å¤„ç†

### 2. åˆ†æ‰¹å¤„ç†å¤§å‹ä»»åŠ¡
å¯¹äºå¤§é‡å¹»ç¯ç‰‡ï¼ˆ>50å¼ ï¼‰ï¼Œå»ºè®®åˆ†æ‰¹å¤„ç†ï¼š
```python
# å°†50å¼ å¹»ç¯ç‰‡åˆ†æˆ5æ‰¹ï¼Œæ¯æ‰¹10å¼ 
batches = [slides[i:i+10] for i in range(0, len(slides), 10)]

for batch in batches:
    result = await batch_generate(batch, max_workers=8)
    # çŸ­æš‚ä¼‘æ¯é¿å…APIé™åˆ¶
    await asyncio.sleep(5)
```

### 3. é”™è¯¯é‡è¯•ç­–ç•¥
```python
import asyncio
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(stop=stop_after_attempt(3), wait=wait_exponential(multiplier=1, min=4, max=10))
async def robust_batch_generate(slides, max_workers=5):
    return await batch_generate(slides, max_workers)
```

## é…ç½®éªŒè¯å·¥å…·

### è¿è¡Œæµ‹è¯•è„šæœ¬
```bash
cd backend
python test_batch_generation.py
```

### æ£€æŸ¥é…ç½®åˆç†æ€§
```bash
# æ£€æŸ¥å½“å‰é…ç½®
curl http://localhost:8000/api/slide/batch/config/validate

# è·å–ç‰¹å®šæ•°é‡çš„æœ€ä¼˜é…ç½®
curl -X POST http://localhost:8000/api/slide/batch/config/optimal \
  -H "Content-Type: application/json" \
  -d '{"slides_count": 20}'
```

## æœ€ä½³å®è·µæ€»ç»“

1. **ä»ä¿å®ˆå¼€å§‹**: å…ˆä½¿ç”¨è¾ƒä½çš„å¹¶å‘æ•°ï¼Œé€æ­¥å¢åŠ 
2. **ç›‘æ§APIé™åˆ¶**: å¯†åˆ‡å…³æ³¨é€Ÿç‡é™åˆ¶å’Œé”™è¯¯ç‡
3. **å®šæœŸæ¸…ç†**: ä½¿ç”¨è‡ªåŠ¨æ¸…ç†åŠŸèƒ½é¿å…å†…å­˜æ³„æ¼
4. **åˆ†æ‰¹å¤„ç†**: å¤§é‡ä»»åŠ¡åˆ†æ‰¹å¤„ç†ï¼Œé¿å…å•æ¬¡è¯·æ±‚è¿‡é•¿
5. **é”™è¯¯å¤„ç†**: å®ç°é‡è¯•æœºåˆ¶å’Œé™çº§ç­–ç•¥
6. **æ€§èƒ½æµ‹è¯•**: åœ¨ç”Ÿäº§ç¯å¢ƒå‰è¿›è¡Œå……åˆ†çš„æ€§èƒ½æµ‹è¯•

## å®‰å…¨è€ƒè™‘

1. **èµ„æºé™åˆ¶**: è®¾ç½®åˆç†çš„æœ€å¤§å€¼é˜²æ­¢èµ„æºè€—å°½
2. **æƒé™æ§åˆ¶**: é™åˆ¶æ‰¹é‡ç”Ÿæˆæ¥å£çš„è®¿é—®æƒé™
3. **ç›‘æ§å‘Šè­¦**: è®¾ç½®æ€§èƒ½ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
4. **æ—¥å¿—å®¡è®¡**: è®°å½•æ‰€æœ‰æ‰¹é‡æ“ä½œç”¨äºå®¡è®¡

é€šè¿‡åˆç†é…ç½®å¹¶å‘å‚æ•°ï¼Œä½ å¯ä»¥æ˜¾è‘—æå‡æ‰¹é‡å›¾ç‰‡ç”Ÿæˆçš„æ•ˆç‡ï¼ŒåŒæ—¶ä¿æŒç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚