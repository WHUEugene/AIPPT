这份文档整合了项目架构、Prompt Pipeline 细节、批量生成优化（多进程）、以及最新的系统配置与尺寸管理功能。它旨在作为 AI-PPT Flow 项目的**全景技术白皮书**。

---

# AI-PPT Flow 项目全景技术文档

**文档版本**: v1.3.1  
**最后更新**: 2025-12-11  
**适用范围**: 后端开发、前端开发、运维部署

---

## 1. 项目概述

**AI-PPT Flow** 是一个端到端的自动化演示文稿生成系统。它利用大语言模型（LLM）进行文本结构化和风格分析，利用视觉语言模型（VLM）生成高质量的幻灯片背景图。系统支持从"一句话"或"一段文档"出发，结合参考图片的视觉风格，自动产出可编辑的 PowerPoint 文件。

### 1.1 核心特性
*   **视觉克隆 (Visual Cloning)**: 基于上传的参考图，提取配色、构图、材质等风格特征。
*   **智能编剧 (AI Screenwriter)**: 自动拆解长文档，生成结构化的幻灯片大纲（封面/目录/内容/封底）。
*   **多模态生成 (Multimodal Generation)**: 使用 Google Gemini 3 Pro 同时处理文本指令和图像生成，支持文字直接嵌入图片。
*   **高并发渲染 (High Concurrency)**: 基于多进程架构的批量图片生成引擎，支持 5-10 倍的生成速度提升。
*   **所见即所得 (WYSIWYG)**: 前端实时预览生成的图片，支持单页重绘和参数微调。

---

## 2. 系统架构

### 2.1 整体架构
采用前后端分离架构，通过 RESTful API 通信。

```mermaid
graph TD
    User[用户 (Browser)] --> FE[前端 (React + Vite)]
    FE --> BE[后端 (FastAPI + Python)]
    
    subgraph Backend Services
        BE --> ConfigMgr[配置管理器]
        BE --> StyleEng[风格分析引擎]
        BE --> OutlineEng[大纲生成引擎]
        BE --> ImageEng[图像生成引擎]
        BE --> ExportEng[PPTX 导出引擎]
        BE --> Storage[本地文件存储 (JSON/Images)]
    end
    
    subgraph External AI
        StyleEng --> LLM[OpenRouter API]
        OutlineEng --> LLM
        ImageEng --> VLM[Gemini 3 Pro (Image Mode)]
    end
```

### 2.2 技术栈
| 领域           | 技术选型             | 说明               |
| :------------- | :------------------- | :----------------- |
| **Frontend**   | React 18, TypeScript | UI 框架            |
|                | Tailwind CSS         | 样式库             |
|                | Zustand              | 状态管理           |
| **Backend**    | Python 3.10          | 核心语言           |
|                | FastAPI              | Web 框架           |
|                | ProcessPoolExecutor  | 多进程并发处理     |
|                | Pydantic v2          | 数据验证与配置管理 |
|                | python-pptx          | PPT 文件生成       |
| **AI Service** | OpenRouter           | API 网关           |
|                | Google Gemini 3 Pro  | 文本与视觉模型     |

---

## 3. 核心业务流程 (Prompt Pipeline)

本节详细描述数据如何在各个 AI 组件间流转，以及核心 Prompt 的构建逻辑。

### 3.1 阶段一：风格分析 (Style Analysis)
**组件**: `StyleAnalyzer`  
**目标**: 将上传的参考图转化为结构化的文字描述。

1.  **像素级预分析**: 使用 OpenCV/PIL 提取基础特征。
    *   *提取数据*: 主色调 (Hex)、分辨率、亮度 (Luma)、构图 (基于特征点)。
2.  **LLM 风格提取**:
    *   **System Prompt**: `"你是一名严谨客观的视觉风格分析师...禁止编造不存在的元素..."`
    *   **User Input**: 传入像素预分析结果，要求整理为结构化 Style Prompt。
    *   **Output**: 包含四个维度的描述：
        1.  **配色与材质**: 色彩基调、光影质感。
        2.  **构图与层次**: 空间布局、留白处理。
        3.  **画面细节**: 风格流派（如极简、赛博朋克）。
        4.  **负向提示**: 避免出现的元素（如水印、杂乱背景）。

### 3.2 阶段二：大纲生成 (Outline Generation)
**组件**: `OutlineGenerator`  
**目标**: 将非结构化文本转化为 JSON 幻灯片数组。

1.  **Prompt 构建**:
    *   **System Prompt**: `"你是一名专业的 PPT 编剧...输出 JSON 数组..."`
    *   **User Input**: 原始文本 + 预期页数 + 模版名称。
2.  **结构化输出**:
    *   LLM 返回 JSON 数组，每个对象包含：`page_num`, `type` (cover/content), `title`, `content_text`, `visual_desc` (画面描述)。
3.  **容错机制**:
    *   若 LLM 返回非 JSON 格式，触发本地回退算法：按段落平均分割文本，并自动填充通用的视觉描述。

### 3.3 阶段三：提示词组装 (Prompt Assembly)
**组件**: `PromptBuilder`  
**目标**: 将风格、内容、约束组合成最终的绘图指令。

**组装模版**:
```text
Prompt: {style_prompt} (来自阶段一)

### 分页描述
{visual_desc} (来自阶段二)

### 需要内嵌的文字
- 标题：{title}
- 正文：{content_text}

### 输出要求
- 尺寸严格为 {aspect_ratio}
- 画面需兼具丰富图像与可读文字
- 避免无关元素或水印
```

### 3.4 阶段四：图像生成 (Image Generation)
**组件**: `ImageGenerator` / `BatchImageGenerator`  
**目标**: 调用 VLM 生成最终图片。

*   **接口升级 (2025-12-10)**: 从旧版 `/images` 迁移至 `/chat/completions`。
*   **请求构造**:
    ```json
    {
      "model": "google/gemini-3-pro-image-preview",
      "messages": [{"role": "user", "content": final_prompt}],
      "modalities": ["image", "text"]
    }
    ```
*   **结果处理**: 解析响应中的 Base64 图片数据，解码并保存为 JPEG 文件。

---

## 4. 性能优化与并发架构

针对批量生成场景（如一次生成 10-20 页 PPT），系统经历了从单线程到多进程的重构。

### 4.1 演进历程
1.  **串行版本**: 单张生成，耗时 = N * 单张耗时 (约 20s/张)。
2.  **线程池版本 (ThreadPool)**: 使用 `asyncio` + 线程池。受限于 Python **GIL (全局解释器锁)**，在 CPU 密集型的胶水代码和对象创建中存在瓶颈，且 `asyncio.run` 在多线程下有事件循环冲突，导致"伪并发"。
3.  **多进程版本 (ProcessPool)**: **当前方案**。

### 4.2 多进程架构 (Multiprocessing)
使用 `ProcessPoolExecutor` 实现真正的并行计算。

*   **独立 Worker**: 定义模块级函数 `_generate_slide_worker`。
    *   每个进程拥有独立的内存空间。
    *   每个进程独立初始化 `OpenRouterClient` 和 `ImageGenerator`。
    *   每个进程创建独立的 `asyncio` 事件循环。
*   **数据序列化**:
    *   主进程将 `SlideData` 对象转换为 `dict` 传递给子进程。
    *   子进程返回结果后，主进程再反序列化为对象。
*   **智能并发控制**:
    *   默认策略: `min(slide_count, 10)`。即 5 页 PPT 开 5 个进程，20 页 PPT 开 10 个进程。

### 4.3 性能对比
| 场景 (5页 PPT) | 耗时     | 提升幅度       |
| :------------- | :------- | :------------- |
| 串行生成       | ~100s    | -              |
| 线程池并发     | ~80s     | 20%            |
| **多进程并发** | **~25s** | **400% (4倍)** |

---

## 5. 高级功能模块

### 5.1 比例与尺寸管理 (Dimension Manager)
支持多种幻灯片比例，适应不同屏幕需求。
*   **组件**: `DimensionCalculator`
*   **支持比例**: 16:9 (默认), 4:3, 1:1, 9:16 (手机), 21:9 (超宽屏)。
*   **实现**: 前端选择比例 -> API 传递参数 -> PromptBuilder 将尺寸约束写入提示词 -> VLM 生成对应比例图片。

### 5.2 系统配置管理 (Config Manager)
提供 Web 界面动态管理后端配置，无需重启服务。
*   **配置文件**: `backend/data/config.json`
*   **管理能力**:
    *   LLM API Key & Base URL 热更新。
    *   模型切换 (Chat Model / Image Model)。
    *   连接测试 (Ping AI Service)。
*   **安全**: API Key 在前端脱敏显示，后端支持配置文件备份。

### 5.3 项目持久化
*   **自动保存**: 批量生成结束或内容变更 5 分钟后自动落盘。
*   **存储结构**: 每个项目保存为一个 JSON 文件，包含完整的 Prompt、图片路径和大纲结构。
*   **历史回溯**: 支持加载历史项目继续编辑。

---

## 6. API 接口参考

### 6.1 核心生成接口

#### 批量生成图片
`POST /api/slide/batch/generate`
```json
{
  "slides": [{"id": "...", "visual_desc": "..."}],
  "style_prompt": "...",
  "max_workers": 5,
  "aspect_ratio": "16:9"
}
```

#### 查询批量任务状态
`POST /api/slide/batch/status`
```json
{ "batch_id": "uuid" }
// Response
{
  "status": "completed",
  "progress": 1.0,
  "results": [...]
}
```

### 6.2 辅助接口
*   **模板分析**: `POST /api/template/analyze` (上传图片 -> 返回 Style Prompt)
*   **大纲生成**: `POST /api/outline/generate` (文本 -> 返回 Slide 数组)
*   **PPT 导出**: `POST /api/export/pptx` (项目数据 -> 返回二进制流)
*   **配置更新**: `POST /api/config/update`

---

## 7. 部署与环境

### 7.1 环境变量 (.env)
```bash
# 必须配置
LLM_API_KEY=sk-or-v1-...
LLM_API_BASE=https://openrouter.ai/api/v1

# 可选配置 (有默认值)
BATCH_DEFAULT_WORKERS=5
BATCH_MAX_WORKERS=10
IMAGE_OUTPUT_DIR=backend/generated/images
```

### 7.2 目录结构
```
backend/
├── app/
│   ├── services/
│   │   ├── style_analyzer.py      # 风格分析
│   │   ├── outline_generator.py   # 大纲生成
│   │   ├── batch_image_generator.py # 多进程图片生成 (核心)
│   │   ├── config_manager.py      # 配置管理
│   │   ├── prompt_builder.py      # 提示词组装
│   │   └── llm_client.py          # AI客户端封装
│   └── routers/                   # API 路由
├── data/
│   ├── config.json                # 系统配置 (唯一配置源)
│   └── projects/                  # 项目存档
├── generated/                     # 生成产物
└── .env.deprecated                # 环境变量备份 (已废弃)
```

### 7.3 常见问题排查
1.  **图片生成失败**:
    *   检查 API Key 是否有 Gemini 3 Pro 权限。
    *   检查日志 `logs/pipeline_*.log` 中的 `LLMClientError`。
    *   确认使用的是 `config.json` 而非 `.env` 配置。
2.  **批量生成卡死**:
    *   检查服务器内存是否足够（每个进程约需 100MB）。
    *   减少 `max_workers` 数量。
3.  **PPT 导出无图**:
    *   确认 `backend/generated/images` 下图片文件是否存在。
    *   确认前端传递的 `image_url` 路径正确。
4.  **配置不生效**:
    *   检查是否已移除 `.env` 文件（已改名为 `.env.deprecated`）。
    *   确认配置保存到 `backend/data/config.json`。
    *   重启后端服务确保配置加载。
5.  **图片404错误**:
    *   检查图片文件是否存在于 `backend/generated/images/` 目录。
    *   确认静态文件路由配置正确。
    *   查看日志中的图片保存路径与实际文件位置是否匹配。

---

## 8. 最近更新记录 (2025-12-11)

### 8.1 配置系统统一
**问题**: 前端Settings界面保存配置到`config.json`，但后端优先读取`.env`环境变量，导致配置不一致。

**解决方案**:
1. **移除环境变量支持**: 禁用`SettingsConfigDict`的`.env`配置
2. **统一配置源**: 所有配置都从`backend/data/config.json`读取
3. **移除配置缓存**: 确保配置更新能实时生效
4. **备份环境变量**: 将`.env`重命名为`.env.deprecated`

**影响文件**:
- `backend/app/config.py`: 注释掉环境变量配置
- `backend/app/services/config_manager.py`: 移除环境变量默认值
- `backend/app/dependencies.py`: 移除`@lru_cache`装饰器

### 8.2 核心Bug修复
1. **PromptBuilder构造函数错误**: 修复批量生成中`PromptBuilder(llm_client)`调用错误
2. **NoneType处理**: 修复`len(payload.content_text)`当`content_text`为None时的错误

**影响文件**:
- `backend/app/services/batch_image_generator.py`: 修复PromptBuilder调用
- `backend/app/routers/slide.py`: 添加空值检查

### 8.3 图片路径修复
**问题**: 批量生成过程中图片保存到错误位置，导致大量404错误。

**根本原因**: 
- 配置修改过程中路径不一致
- 图片被保存到`backend/backend/generated/images/`而非`backend/generated/images/`

**解决方案**:
```bash
# 批量移动图片文件
mv /Users/linyong/vscode/AIPPT/backend/backend/generated/images/*.jpg /Users/linyong/vscode/AIPPT/backend/generated/images/
```

**修复成果**:
- ✅ 100+个图片文件移动到正确位置
- ✅ 所有404错误恢复正常
- ✅ 前端历史项目图片显示正常

### 8.4 图片尺寸问题 (待解决)
**当前状态**: 
- 后端日志显示1920x1080
- 实际保存的图片仍为1376x768
- 可能是OpenRouter API不支持自定义尺寸参数

**已完成的修复**:
- ✅ 使用`DimensionCalculator`正确计算尺寸
- ✅ 后端日志正确显示请求尺寸
- ❓ 实际生成尺寸需要进一步调查

---

## 9. 未来规划
*   **v1.3**: 用户认证系统 (JWT)、WebSocket 实时进度推送。
*   **v2.0**: 多人协作编辑、支持更多 AI 模型 (Midjourney, DALL-E 3)、移动端适配。