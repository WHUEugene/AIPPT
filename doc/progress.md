è¿™æ˜¯ä¸€ä¸ªæ ¹æ®é¡¹ç›®è®¾è®¡ä¸å¼€å‘æ¼”è¿›é¡ºåºé‡æ–°æ•´ç†çš„ç»¼åˆæŠ€æœ¯æ–‡æ¡£ã€‚è¯¥æ–‡æ¡£å°†é¡¹ç›®ä»åŸºç¡€æ¶æ„æ­å»ºã€æ ¸å¿ƒåŠŸèƒ½å®ç°ã€æ€§èƒ½ä¼˜åŒ–åˆ°ç³»ç»Ÿé…ç½®ç®¡ç†çš„å®Œæ•´å¼€å‘å†ç¨‹è¿›è¡Œäº†é€»è¾‘ä¸²è”ã€‚

---

# AI-PPT Flow é¡¹ç›®è®¾è®¡ä¸å¼€å‘æ¼”è¿›æ–‡æ¡£

**ç‰ˆæœ¬**: 1.2.0 (ç»¼åˆç‰ˆ)  
**æœ€åæ›´æ–°**: 2025-12-10

## ç›®å½•

1.  [ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒæ¶æ„ä¸MVPåŸºç¡€ (Foundation)](#ç¬¬ä¸€é˜¶æ®µæ ¸å¿ƒæ¶æ„ä¸mvpåŸºç¡€-foundation)
2.  [ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®æŒä¹…åŒ–ä¸é¡¹ç›®ç®¡ç† (Project Management)](#ç¬¬äºŒé˜¶æ®µæ•°æ®æŒä¹…åŒ–ä¸é¡¹ç›®ç®¡ç†-project-management)
3.  [ç¬¬ä¸‰é˜¶æ®µï¼šæ‰¹é‡ç”ŸæˆåŠŸèƒ½ä¸å¹¶å‘è®¾è®¡ (Batch Generation)](#ç¬¬ä¸‰é˜¶æ®µæ‰¹é‡ç”ŸæˆåŠŸèƒ½ä¸å¹¶å‘è®¾è®¡-batch-generation)
4.  [ç¬¬å››é˜¶æ®µï¼šæ€§èƒ½é‡æ„ - å¤šè¿›ç¨‹ä¼˜åŒ– (Performance Optimization)](#ç¬¬å››é˜¶æ®µæ€§èƒ½é‡æ„---å¤šè¿›ç¨‹ä¼˜åŒ–-performance-optimization)
5.  [ç¬¬äº”é˜¶æ®µï¼šé«˜çº§é…ç½®ä¸è‡ªå®šä¹‰åŠŸèƒ½ (Configuration & Customization)](#ç¬¬äº”é˜¶æ®µé«˜çº§é…ç½®ä¸è‡ªå®šä¹‰åŠŸèƒ½-configuration--customization)
6.  [é™„å½•ï¼šç³»ç»Ÿéƒ¨ç½²ä¸APIå‚è€ƒ](#é™„å½•ç³»ç»Ÿéƒ¨ç½²ä¸apiå‚è€ƒ)

---

## ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒæ¶æ„ä¸MVPåŸºç¡€ (Foundation)

### 1.1 é¡¹ç›®æ¦‚è¿°
AI-PPT Flow æ˜¯ä¸€ä¸ªåŸºäºå¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰å’Œè§†è§‰è¯­è¨€æ¨¡å‹ï¼ˆVLMï¼‰çš„è‡ªåŠ¨åŒ–æ¼”ç¤ºæ–‡ç¨¿ç”Ÿæˆç³»ç»Ÿã€‚é¡¹ç›®æ—¨åœ¨é€šè¿‡ç”¨æˆ·ä¸Šä¼ çš„å‚è€ƒæ¨¡æ¿å’Œæ–‡æ¡£å†…å®¹ï¼Œè‡ªåŠ¨ç”Ÿæˆé£æ ¼ç»Ÿä¸€ã€ç»“æ„æ¸…æ™°çš„PPTã€‚

### 1.2 ç³»ç»Ÿæ¶æ„
é‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼š
*   **å‰ç«¯**: React 18 + TypeScript + Vite + Tailwind CSS (çŠ¶æ€ç®¡ç†: Zustand)
*   **åç«¯**: FastAPI + Python 3.10 (å¼‚æ­¥å¤„ç†: asyncio)
*   **AIæœåŠ¡**: OpenRouter (Google Gemini 3 Pro / Image Preview)

### 1.3 æ ¸å¿ƒç»„ä»¶è®¾è®¡
MVPé˜¶æ®µç¡®ç«‹äº†äº”ä¸ªæ ¸å¿ƒæœåŠ¡ç»„ä»¶ï¼š

1.  **é£æ ¼åˆ†æå™¨ (StyleAnalyzer)**
    *   **åŠŸèƒ½**: åˆ†æä¸Šä¼ çš„æ¨¡æ¿å›¾ç‰‡ï¼Œæå–è§†è§‰é£æ ¼ï¼ˆé…è‰²ã€æ„å›¾ã€æè´¨ï¼‰ã€‚
    *   **æŠ€æœ¯**: ç»“åˆåƒç´ çº§åˆ†æï¼ˆOpenCV/PILï¼‰ä¸ LLM è§†è§‰ç†è§£ï¼Œè¾“å‡ºç»“æ„åŒ–çš„ Style Promptã€‚

2.  **å¤§çº²ç”Ÿæˆå™¨ (OutlineGenerator)**
    *   **åŠŸèƒ½**: å°†é•¿æ–‡æ¡£æ‹†è§£ä¸º JSON æ ¼å¼çš„å¹»ç¯ç‰‡å¤§çº²ï¼ˆå°é¢ã€ç›®å½•ã€å†…å®¹é¡µï¼‰ã€‚
    *   **æŠ€æœ¯**: ä½¿ç”¨ LLM è¿›è¡Œæ–‡æœ¬æ‘˜è¦å’Œç»“æ„åŒ–æå–ï¼ŒåŒ…å«å¤‡ç”¨çš„æœ¬åœ°æ‹†åˆ†ç®—æ³•ã€‚

3.  **æç¤ºè¯æ„å»ºå™¨ (PromptBuilder)**
    *   **åŠŸèƒ½**: ç»„è£…ç”¨äºç»˜å›¾çš„æœ€ç»ˆæç¤ºè¯ã€‚
    *   **é€»è¾‘**: `Style Prompt` + `Visual Description` + `Content Text` + `Aspect Ratio Constraint`ã€‚

4.  **å›¾åƒç”Ÿæˆå™¨ (ImageGenerator)**
    *   **åŠŸèƒ½**: è°ƒç”¨ VLM API ç”Ÿæˆå¹»ç¯ç‰‡èƒŒæ™¯å›¾ã€‚
    *   **æ¼”è¿›**: ä»æ—§ç‰ˆ `generate_image` æ¥å£è¿ç§»è‡³æ–°çš„ Chat Completions æ¥å£ï¼ˆæ”¯æŒ modalities: ["image", "text"]ï¼‰ï¼Œç›´æ¥è¿”å› Base64 æˆ– URLã€‚

5.  **PPTXå¯¼å‡ºå™¨ (PPTXExporter)**
    *   **åŠŸèƒ½**: ä½¿ç”¨ `python-pptx` å°†ç”Ÿæˆçš„å›¾ç‰‡å’Œæ–‡æœ¬åˆæˆä¸ºå¯ç¼–è¾‘çš„ `.pptx` æ–‡ä»¶ã€‚

---

## ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®æŒä¹…åŒ–ä¸é¡¹ç›®ç®¡ç† (Project Management)

éšç€åŸºç¡€ç”ŸæˆåŠŸèƒ½çš„è·‘é€šï¼Œç³»ç»Ÿå¼•å…¥äº†é¡¹ç›®çŠ¶æ€ç®¡ç†å’Œæ•°æ®æŒä¹…åŒ–èƒ½åŠ›ã€‚

### 2.1 å­˜å‚¨ç³»ç»Ÿè®¾è®¡
*   **æœ¬åœ°å­˜å‚¨**: é¡¹ç›®æ•°æ®æŒä¹…åŒ–åˆ° `backend/data/projects/`ã€‚
*   **æ•°æ®ç»“æ„**:
    *   `ProjectSchema`: åŒ…å«é¡¹ç›®IDã€æ ‡é¢˜ã€åˆ›å»º/æ›´æ–°æ—¶é—´ã€æ¨¡æ¿ä¿¡æ¯åŠå¹»ç¯ç‰‡åˆ—è¡¨ã€‚
    *   è‡ªåŠ¨ç”Ÿæˆé¡¹ç›®ç¼©ç•¥å›¾å’Œå…ƒæ•°æ®ã€‚

### 2.2 åŠŸèƒ½å®ç°
*   **è‡ªåŠ¨ä¿å­˜**:
    *   æ‰¹é‡ç”Ÿæˆå®Œæˆåè‡ªåŠ¨ä¿å­˜ã€‚
    *   ç¼–è¾‘å†…å®¹å 5 åˆ†é’Ÿè‡ªåŠ¨ä¿å­˜ã€‚
*   **å†å²è®°å½• (History)**:
    *   å‰ç«¯æ–°å¢ History é¡µé¢ï¼Œæ”¯æŒæŸ¥çœ‹ã€ç»§ç»­ç¼–è¾‘å’Œåˆ é™¤å†å²é¡¹ç›®ã€‚
    *   æ”¯æŒé¡¹ç›®æ¢å¤å’Œé¡µé¢å…³é—­å‰çš„æœªä¿å­˜æé†’ã€‚

---

## ç¬¬ä¸‰é˜¶æ®µï¼šæ‰¹é‡ç”ŸæˆåŠŸèƒ½ä¸å¹¶å‘è®¾è®¡ (Batch Generation)

ä¸ºäº†è§£å†³å•å¼ ç”Ÿæˆæ•ˆç‡ä½ä¸‹çš„é—®é¢˜ï¼ˆå•å¼ éœ€15-30ç§’ï¼Œ5é¡µéœ€2åˆ†é’Ÿä»¥ä¸Šï¼‰ï¼Œå¼€å‘äº†æ‰¹é‡ç”Ÿæˆç³»ç»Ÿã€‚

### 3.1 æ¥å£è®¾è®¡
æ–°å¢ `POST /api/slide/batch/generate` æ¥å£ï¼š
```json
{
  "slides": [...],
  "style_prompt": "...",
  "max_workers": 3,
  "aspect_ratio": "16:9"
}
```
ä»¥åŠçŠ¶æ€æŸ¥è¯¢æ¥å£ `POST /api/slide/batch/status`ï¼Œæ”¯æŒå‰ç«¯è½®è¯¢è¿›åº¦ã€‚

### 3.2 åˆå§‹å¹¶å‘ç­–ç•¥ (åŸºäºçº¿ç¨‹æ± )
æœ€åˆç‰ˆæœ¬ä½¿ç”¨ `ThreadPoolExecutor` é…åˆ `asyncio`ã€‚
*   **å¹¶å‘æ§åˆ¶**: å…è®¸é…ç½® `max_workers` (1-10)ã€‚
*   **çŠ¶æ€è·Ÿè¸ª**: å¼•å…¥ `session_id`ï¼Œè®°å½•æ¯ä¸ªå¹»ç¯ç‰‡çš„ç”ŸæˆçŠ¶æ€ï¼ˆpending/generating/done/failedï¼‰ã€‚
*   **å‰ç«¯ä¼˜åŒ–**: è¿›å…¥é¡µé¢è‡ªåŠ¨æ£€æµ‹å¹¶è§¦å‘æ‰¹é‡ç”Ÿæˆï¼Œå®æ—¶æ˜¾ç¤ºè¿›åº¦æ¡ã€‚

### 3.3 å¹¶å‘é…ç½®æŒ‡å—
åˆ¶å®šäº†ä¸åŒè´Ÿè½½ä¸‹çš„é…ç½®å»ºè®®ï¼š
*   **1-3å¼ **: 2-3 å¹¶å‘
*   **4-10å¼ **: 5-8 å¹¶å‘ (æœ€ä½³æ€§èƒ½åŒºé—´)
*   **20+å¼ **: å»ºè®®åˆ†æ‰¹å¤„ç†æˆ–ä½¿ç”¨ 12-20 å¹¶å‘ (éœ€æ³¨æ„ API Rate Limit)

---

## ç¬¬å››é˜¶æ®µï¼šæ€§èƒ½é‡æ„ - å¤šè¿›ç¨‹ä¼˜åŒ– (Performance Optimization)

åœ¨æ‰¹é‡åŠŸèƒ½ä¸Šçº¿åï¼Œå‘ç°æ€§èƒ½ç“¶é¢ˆï¼šè®¾ç½®å¤šä¸ª workers ä½†é€Ÿåº¦æå‡ä¸æ˜æ˜¾ã€‚

### 4.1 é—®é¢˜è¯Šæ–­
*   **ç°è±¡**: `ThreadPoolExecutor` + `asyncio.run()` å¯¼è‡´ä»»åŠ¡å®é™…ä¸Šæ˜¯ä¸²è¡Œæˆ–ä¼ªå¹¶å‘æ‰§è¡Œã€‚
*   **æ ¹å› **: Python çš„ **GIL (å…¨å±€è§£é‡Šå™¨é”)** é™åˆ¶äº†åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ Python å­—èŠ‚ç ã€‚è™½ç„¶ç½‘ç»œ I/O ä¼šé‡Šæ”¾ GILï¼Œä½†åœ¨å¤„ç†å¤§é‡èƒ¶æ°´é€»è¾‘å’Œå¯¹è±¡åˆ›å»ºæ—¶ï¼Œçº¿ç¨‹ç«äº‰å¯¼è‡´æ•ˆç‡ä½ä¸‹ã€‚

### 4.2 æ¶æ„é‡æ„ (Threading -> Multiprocessing)
å°† `ThreadPoolExecutor` æ›¿æ¢ä¸º `ProcessPoolExecutor`ï¼Œå®ç°çœŸæ­£çš„å¹¶è¡Œè®¡ç®—ã€‚

**æ ¸å¿ƒæ”¹åŠ¨**:
1.  **ç‹¬ç«‹ Worker å‡½æ•°**:
    åˆ›å»ºæ¨¡å—çº§å‡½æ•° `_generate_slide_worker`ï¼Œåœ¨æ¯ä¸ªè¿›ç¨‹ä¸­ç‹¬ç«‹åˆå§‹åŒ– `OpenRouterClient` å’Œ `ImageGenerator`ï¼Œé¿å…è·¨è¿›ç¨‹å…±äº«å¯¹è±¡çš„å¤æ‚æ€§ã€‚
    ```python
    def _generate_slide_worker(slide_data, style_prompt, ...):
        # æ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹çš„äº‹ä»¶å¾ªç¯
        loop = asyncio.new_event_loop()
        result = loop.run_until_complete(generate_image())
        return result
    ```

2.  **æ•°æ®åºåˆ—åŒ–**:
    *   å°† `SlideData` å¯¹è±¡è½¬æ¢ä¸ºå­—å…¸è¿›è¡Œè¿›ç¨‹é—´ä¼ é€’ã€‚
    *   é…ç½®ä¿¡æ¯åºåˆ—åŒ–ä¼ é€’ï¼Œç»“æœååºåˆ—åŒ–ã€‚

3.  **æ™ºèƒ½å¹¶å‘é…ç½®**:
    ```python
    # è‡ªåŠ¨ä¼˜åŒ–ï¼š1-10é¡µä½¿ç”¨é¡µæ•°ä¸ªworkerï¼Œä¸Šé™ä¸º10
    if max_workers is None:
        max_workers = min(len(slides), 10)
    ```

### 4.3 ä¼˜åŒ–æˆæœ
*   **æ€§èƒ½æå‡**: ç†è®ºæå‡ 5-10 å€ã€‚æ€»è€—æ—¶ä»"æ‰€æœ‰å¹»ç¯ç‰‡ç”Ÿæˆæ—¶é—´ä¹‹å’Œ"ç¼©çŸ­ä¸º"æœ€æ…¢é‚£å¼ å¹»ç¯ç‰‡çš„ç”Ÿæˆæ—¶é—´"ã€‚
*   **èµ„æºåˆ©ç”¨**: å……åˆ†åˆ©ç”¨å¤šæ ¸ CPUã€‚

---

## ç¬¬äº”é˜¶æ®µï¼šé«˜çº§é…ç½®ä¸è‡ªå®šä¹‰åŠŸèƒ½ (Configuration & Customization)

ä¸ºäº†æå‡ç³»ç»Ÿçš„çµæ´»æ€§å’Œæ˜“ç”¨æ€§ï¼Œæœ€è¿‘ï¼ˆ2025-12-10ï¼‰å¢åŠ äº†ç³»ç»Ÿçº§é…ç½®å’Œç”»é¢æ¯”ä¾‹æ§åˆ¶ã€‚

### 5.1 æ¨¡ç‰ˆæ¯”ä¾‹ä¸å°ºå¯¸è®¾å®š
*   **åç«¯**:
    *   `DimensionCalculator` å·¥å…·ç±»ï¼šæ”¯æŒ 16:9, 4:3, 1:1, 9:16, 21:9 ç­‰æ ‡å‡†æ¯”ä¾‹åŠè‡ªå®šä¹‰å°ºå¯¸è®¡ç®—ã€‚
    *   PromptBuilder é€‚é…ï¼šå°†å°ºå¯¸çº¦æŸå†™å…¥æç¤ºè¯ã€‚
*   **å‰ç«¯**:
    *   æ–°å¢ `AspectRatioSelector` ç»„ä»¶ã€‚
    *   æ”¯æŒåœ¨ Workspace å®æ—¶ä¿®æ”¹æ¯”ä¾‹ï¼Œè§¦å‘é‡æ–°ç”Ÿæˆã€‚

### 5.2 ç³»ç»Ÿé…ç½®ç®¡ç† (Config Manager)
å®ç°äº†å®Œæ•´çš„é…ç½®ç®¡ç†ç³»ç»Ÿï¼Œå…è®¸ç”¨æˆ·é€šè¿‡ UI ä¿®æ”¹åç«¯å‚æ•°ã€‚

*   **æ¶æ„**:
    *   `ConfigManager`: å¤„ç†é…ç½®çš„è¯»å–ã€æ›´æ–°ã€éªŒè¯å’Œé‡ç½®ã€‚
    *   é…ç½®æ–‡ä»¶: `backend/data/config.json` (å«å¤‡ä»½æœºåˆ¶)ã€‚
*   **åŠŸèƒ½**:
    *   **API è®¾ç½®**: åŠ¨æ€ä¿®æ”¹ OpenRouter Keyã€Base URLã€æ¨¡å‹åç§°ã€‚
    *   **è¿æ¥æµ‹è¯•**: UI å¢åŠ "æµ‹è¯•è¿æ¥"æŒ‰é’®ï¼ŒéªŒè¯ AI æœåŠ¡è¿é€šæ€§ã€‚
    *   **å®‰å…¨**: API Key å‰ç«¯è„±æ•æ˜¾ç¤ºã€‚

---

## é™„å½•ï¼šç³»ç»Ÿéƒ¨ç½²ä¸APIå‚è€ƒ

### éƒ¨ç½²ç¯å¢ƒ
*   **Backend**: Python 3.10+, FastAPI, Uvicorn
*   **Frontend**: Node.js 18+, React, Vite
*   **Docker**: æ”¯æŒ Docker Compose ä¸€é”®éƒ¨ç½²

### å…³é”® API æ¦‚è§ˆ

| åŠŸèƒ½     | æ–¹æ³• | è·¯å¾„                        | æè¿°               |
| :------- | :--- | :-------------------------- | :----------------- |
| **ç”Ÿæˆ** | POST | `/api/slide/batch/generate` | å¤šè¿›ç¨‹æ‰¹é‡ç”Ÿæˆå›¾ç‰‡ |
| **çŠ¶æ€** | POST | `/api/slide/batch/status`   | æŸ¥è¯¢æ‰¹é‡ä»»åŠ¡è¿›åº¦   |
| **é…ç½®** | GET  | `/api/config/`              | è·å–å½“å‰ç³»ç»Ÿé…ç½®   |
| **é…ç½®** | POST | `/api/config/update`        | æ›´æ–°ç³»ç»Ÿé…ç½®       |
| **é¡¹ç›®** | POST | `/api/projects/save`        | ä¿å­˜é¡¹ç›®çŠ¶æ€       |
| **å¯¼å‡º** | POST | `/api/export/pptx`          | å¯¼å‡º PPTX æ–‡ä»¶     |

### ç›‘æ§ä¸è°ƒè¯•
*   **æ—¥å¿—ä½ç½®**: `logs/pipeline_YYYYMMDD.log`
*   **æ€§èƒ½æŒ‡æ ‡**:
    *   æŸ¥çœ‹æ‰¹é‡ä»»åŠ¡ç»Ÿè®¡: `grep "batch_generate_complete" logs/...`
    *   æŸ¥çœ‹å•é¡µç”Ÿæˆæ—¶é—´: `grep "slide_completed" logs/...`

---

## PPTX å¯¼å‡ºåŠŸèƒ½ä¿®å¤è®°å½• (2025-12-10)

### é—®é¢˜ç°è±¡
- PPTX å¯¼å‡ºæ–‡ä»¶ç”Ÿæˆæ­£å¸¸ï¼Œä½†å¹»ç¯ç‰‡æ˜¾ç¤ºä¸ºç©ºç™½
- æ—¥å¿—æ˜¾ç¤ºå›¾ç‰‡æ·»åŠ æˆåŠŸï¼Œä½†å®é™…å†…å®¹ä¸å¯è§

### æ ¹æœ¬åŸå› åˆ†æ

#### 1. æ ¸å¿ƒé—®é¢˜ï¼šå•ä½æ¢ç®—é”™è¯¯ âŒ
**æ–‡ä»¶ä½ç½®**: `backend/app/services/pptx_exporter.py`

**é”™è¯¯ä»£ç **:
```python
# å°†PPTXçš„EMUå•ä½è½¬æ¢ä¸ºè‹±å¯¸
slide_width_inches = slide_width / 914400
slide_height_inches = slide_height / 914400

picture = slide.shapes.add_picture(
    str(image_path), 0, 0,
    width=slide_width_inches, height=slide_height_inches  # é”™è¯¯ï¼šä¼ å…¥äº†å°æ•°è‹±å¯¸å€¼
)
```

**é—®é¢˜åˆ†æ**:
- `python-pptx` çš„ `add_picture` æ–¹æ³•ä¼ å…¥çº¯æ•°å­—æ—¶ï¼Œé»˜è®¤è®¤ä¸ºæ˜¯ **EMU** å•ä½
- ä»£ç ä¸­å°† EMU è½¬æ¢ä¸ºè‹±å¯¸åï¼ˆçº¦13.33ï¼‰ï¼Œåˆè¢«å½“ä½œ EMU ä½¿ç”¨
- ç»“æœï¼šå›¾ç‰‡å®½åº¦ä¸º 13 EMU â‰ˆ 0.001 åƒç´ ï¼Œè‚‰çœ¼ä¸å¯è§

**æ­£ç¡®ä¿®å¤**:
```python
# âœ… ç›´æ¥ä½¿ç”¨ EMU å•ä½ï¼Œä¸è¿›è¡Œæ¢ç®—
picture = slide.shapes.add_picture(
    str(image_path), 0, 0,
    width=int(slide_width), height=int(slide_height)  # ç›´æ¥ä½¿ç”¨ EMU
)
```

#### 2. æ¬¡è¦é—®é¢˜ï¼šä¸å­˜åœ¨çš„å±æ€§å¯¼è‡´å¼‚å¸¸ âš ï¸
**é”™è¯¯ä»£ç **:
```python
picture.zorder = 0  # âŒ python-pptx ä¸­æ²¡æœ‰è¿™ä¸ªå±æ€§
```

**é—®é¢˜åˆ†æ**:
- `python-pptx` åº“ä¸­çš„ Picture å¯¹è±¡æ²¡æœ‰ `zorder` å±æ€§
- èµ‹å€¼æ—¶æŠ›å‡º `AttributeError`ï¼Œä½†è¢« try-catch æ•è·
- è¿”å› Falseï¼Œä½†å¹»ç¯ç‰‡å·²åˆ›å»ºï¼Œå¯¼è‡´ç©ºç™½å¹»ç¯ç‰‡

**æ­£ç¡®ä¿®å¤**:
```python
# åˆ é™¤æˆ–æ³¨é‡Šæ‰è¿™è¡Œä»£ç 
# picture.zorder = 0  # python-pptx ä¸­æ²¡æœ‰è¿™ä¸ªå±æ€§
```

#### 3. è·¯å¾„è§£æå¢å¼º ğŸ”§
å¢å¼ºäº† `_resolve_image_path` æ–¹æ³•ï¼Œæ›´å¥½åœ°å¤„ç† HTTP URL æ ¼å¼çš„å›¾ç‰‡è·¯å¾„ã€‚

### ä¿®å¤æ—¶é—´çº¿

1. **åˆå§‹é—®é¢˜**: PPTX å¯¼å‡ºç©ºç™½
2. **è¯¯åˆ¤æ–¹å‘**: æ€€ç–‘å›¾ç‰‡è·¯å¾„é—®é¢˜ï¼Œä¿®å¤äº†é™æ€æ–‡ä»¶è·¯ç”±
3. **å‘ç°å…³é”®**: é€šè¿‡æ—¥å¿—åˆ†æå‘ç°å›¾ç‰‡æ·»åŠ "æˆåŠŸ"ä½†å®é™…ç©ºç™½
4. **å®šä½æ ¹å› **: è¯†åˆ«å‡ºå•ä½æ¢ç®—é”™è¯¯çš„æ ¸å¿ƒé—®é¢˜
5. **å®Œæ•´ä¿®å¤**: ä¿®å¤å•ä½æ¢ç®— + ç§»é™¤é”™è¯¯å±æ€§ + å¢å¼ºè·¯å¾„è§£æ

### æŠ€æœ¯è¦ç‚¹

#### å•ä½æ¢ç®—å…³é”®çŸ¥è¯†
- 1 è‹±å¯¸ = 914400 EMU (English Metric Units)
- 1 åƒç´  â‰ˆ 9525 EMU (96 DPI)
- `python-pptx` çš„ `add_picture` ä¼ å…¥æ•°å­—é»˜è®¤ä¸º EMU

#### è°ƒè¯•ç»éªŒ
- æ—¥å¿—æ˜¾ç¤ºæˆåŠŸä¸ç­‰äºå®é™…æˆåŠŸ
- éœ€è¦éªŒè¯æœ€ç»ˆæ–‡ä»¶çš„ç‰©ç†å†…å®¹
- å•ä½æ¢ç®—æ˜¯ PPTX å¼€å‘çš„å¸¸è§é™·é˜±

### éªŒè¯æ–¹æ³•
```bash
# æ£€æŸ¥æ–‡ä»¶å†…å®¹
unzip -l output.pptx | grep image
# åº”è¯¥çœ‹åˆ° ppt/media/image1.jpg å¹¶æœ‰åˆç†çš„æ–‡ä»¶å¤§å°

# æ£€æŸ¥æ–‡ä»¶æ ¼å¼
file output.pptx
# åº”è¯¥æ˜¾ç¤º "Microsoft OOXML"
```

### çŠ¶æ€
âœ… **å·²ä¿®å¤** - å›¾ç‰‡ç°åœ¨èƒ½æ­£ç¡®é“ºæ»¡å¹»ç¯ç‰‡

---

## ç¬¬å…­é˜¶æ®µï¼šé…ç½®ç»Ÿä¸€ä¸ä»£ç Bugä¿®å¤ (2025-12-11)

### 6.1 é…ç½®ç³»ç»Ÿé‡å¤§é—®é¢˜ä¿®å¤

#### é—®é¢˜å‘ç°ï¼šé…ç½®åŒè½¨åˆ¶
åœ¨æµ‹è¯•åç«¯ç”ŸæˆåŠŸèƒ½æ—¶å‘ç°ä¸¥é‡é—®é¢˜ï¼š
- **å‰ç«¯Settingsç•Œé¢**ä¿å­˜é…ç½®åˆ° `config.json`
- **åç«¯è¿è¡Œæ—¶**ä¼˜å…ˆè¯»å– `.env` ç¯å¢ƒå˜é‡
- ä¸¤ä¸ªé…ç½®æ–‡ä»¶çš„å†…å®¹ä¸ä¸€è‡´ï¼Œå¯¼è‡´å‰ç«¯é…ç½®æ— æ³•ç”Ÿæ•ˆ

#### æ ¹æœ¬åŸå› åˆ†æ
1. **é…ç½®ä¼˜å…ˆçº§æ··ä¹±**ï¼š
   - `backend/app/config.py` ä¸­ä½¿ç”¨ `SettingsConfigDict` æ”¯æŒ `.env` æ–‡ä»¶
   - `ConfigManager` ä¸­é»˜è®¤å€¼ä¹Ÿè¯»å–ç¯å¢ƒå˜é‡
   - å¯¼è‡´å‰ç«¯ä¿å­˜çš„é…ç½®è¢« `.env` è¦†ç›–

2. **å…·ä½“ä¸ä¸€è‡´å†…å®¹**ï¼š
   ```json
   // config.json (å‰ç«¯ä¿å­˜)
   {
     "llm_api_key": "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",
     "llm_api_base": "https://openrouter.ai/api/v1",
     "project_name": "æµ‹è¯•é¡¹ç›®åç§°"
   }
   
   // .env (åç«¯å®é™…ä½¿ç”¨)
   LLM_API_KEY=sk-OzW4YyYML1cruBIyORAOmGQMNrfsj7ScDqbnKqdst3B3us73
   LLM_API_BASE=https://api.chatfire.cn/v1
   ```

#### è§£å†³æ–¹æ¡ˆï¼šç»Ÿä¸€é…ç½®ç®¡ç†
1. **ç§»é™¤ç¯å¢ƒå˜é‡æ”¯æŒ**ï¼š
   ```python
   # backend/app/config.py
   # ç§»é™¤ç¯å¢ƒå˜é‡æ”¯æŒï¼Œç»Ÿä¸€ä½¿ç”¨config.jsoné…ç½®æ–‡ä»¶
   # model_config = SettingsConfigDict(
   #     env_file=".env",
   #     env_file_encoding="utf-8",
   #     env_nested_delimiter="__",
   # )
   ```

2. **ä¿®æ”¹ConfigManageré»˜è®¤å€¼**ï¼š
   ```python
   # backend/app/services/config_manager.py
   # é»˜è®¤é…ç½®ï¼ˆç§»é™¤ç¯å¢ƒå˜é‡æ”¯æŒï¼Œç»Ÿä¸€ä½¿ç”¨config.jsonï¼‰
   self._default_config = AppConfig(
       llm_api_key="",
       llm_api_base="https://openrouter.ai/api/v1",
       # ... å…¶ä»–é»˜è®¤å€¼
   )
   ```

3. **ç§»é™¤é…ç½®ç¼“å­˜**ï¼š
   ```python
   # backend/app/dependencies.py
   def get_llm_client() -> OpenRouterClient:
       """LLMå®¢æˆ·ç«¯å®ä¾‹ï¼ˆç§»é™¤ç¼“å­˜ä»¥ç¡®ä¿é…ç½®æ›´æ–°ç”Ÿæ•ˆï¼‰"""
       config = get_app_config()
       return OpenRouterClient(...)
   ```

4. **å¤‡ä»½ç¯å¢ƒå˜é‡æ–‡ä»¶**ï¼š
   ```bash
   mv .env .env.deprecated
   ```

### 6.2 ä»£ç Bugä¿®å¤

#### Bug 1: PromptBuilderæ„é€ å‡½æ•°é”™è¯¯
**é”™è¯¯ä¿¡æ¯**: `PromptBuilder() takes no arguments`

**é—®é¢˜ä½ç½®**: `backend/app/services/batch_image_generator.py:48`
```python
# é”™è¯¯ä»£ç 
prompt_builder = PromptBuilder(llm_client)  # âŒ PromptBuilderä¸æ¥å—å‚æ•°

# æ­£ç¡®ä¿®å¤
prompt_builder = PromptBuilder()  # âœ… ä¸ä¼ ä»»ä½•å‚æ•°
```

#### Bug 2: NoneTypeé•¿åº¦æ£€æŸ¥é”™è¯¯
**é”™è¯¯ä¿¡æ¯**: `object of type 'NoneType' has no len()`

**é—®é¢˜ä½ç½®**: `backend/app/routers/slide.py:39`
```python
# é”™è¯¯ä»£ç 
content_text_length=len(payload.content_text)  # âŒ content_textå¯èƒ½ä¸ºNone

# æ­£ç¡®ä¿®å¤
content_text_length=len(payload.content_text) if payload.content_text else 0  # âœ… å®‰å…¨æ£€æŸ¥
```

### 6.3 ä¿®å¤éªŒè¯

#### æµ‹è¯•ç»“æœ
1. **é…ç½®ç»Ÿä¸€éªŒè¯**ï¼š
   - âœ… åç«¯æœåŠ¡æˆåŠŸå¯åŠ¨
   - âœ… æˆåŠŸåŠ è½½ `config.json` é…ç½®
   - âœ… é…ç½®APIæ­£å¸¸å·¥ä½œ
   - âœ… AIæœåŠ¡è¿æ¥æµ‹è¯•æˆåŠŸ

2. **å›¾ç‰‡ç”ŸæˆåŠŸèƒ½éªŒè¯**ï¼š
   - âœ… å•å¼ å›¾ç‰‡ç”ŸæˆæˆåŠŸ
   - âœ… è¿”å›æ­£ç¡®çš„å›¾ç‰‡URL: `/assets/slide_cac1f6cd342644ecbb50c141ae7bd40b.jpg`
   - âœ… ç”Ÿæˆå®Œæ•´æç¤ºè¯ï¼ŒåŒ…å«æ ‡é¢˜ã€è§†è§‰æè¿°å’Œå°ºå¯¸è¦æ±‚

#### æˆåŠŸæ—¥å¿—ç¤ºä¾‹
```
2025-12-11 15:43:06 | INFO | [5bb01c51-6978-4739-9dc7-1f6589f7d55f] ğŸ¨ IMAGE | Model: google/gemini-3-pro-image-preview | Size: 1280x720 | Path: Generated 477974 bytes
2025-12-11 15:43:06 | INFO | [5bb01c51-6978-4739-9dc7-1f6589f7d55f] âœ… RESPONSE slide_generate_complete | {"image_url": "/assets/slide_cac1f6cd342644ecbb50c141ae7bd40b.jpg", ...}
```

### 6.4 æŠ€æœ¯è¦ç‚¹æ€»ç»“

1. **é…ç½®ç®¡ç†æœ€ä½³å®è·µ**ï¼š
   - é¿å…é…ç½®åŒè½¨åˆ¶ï¼Œç»Ÿä¸€é…ç½®å…¥å£
   - ç§»é™¤ä¸å¿…è¦çš„ç¼“å­˜æœºåˆ¶ç¡®ä¿é…ç½®å®æ—¶ç”Ÿæ•ˆ
   - ç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶èŒè´£åˆ†ç¦»

2. **Pythonä»£ç å¥å£®æ€§**ï¼š
   - æ„é€ å‡½æ•°å‚æ•°ä¼ é€’è¦å‡†ç¡®
   - å¯¹å¯èƒ½ä¸ºNoneçš„å˜é‡è¿›è¡Œå®‰å…¨æ£€æŸ¥
   - å¼‚å¸¸ä¿¡æ¯è¦æ˜ç¡®ï¼Œä¾¿äºé—®é¢˜å®šä½

3. **ç³»ç»Ÿè°ƒè¯•ç»éªŒ**ï¼š
   - é…ç½®ä¸ä¸€è‡´é—®é¢˜éœ€è¦ç³»ç»Ÿæ€§åœ°è§£å†³
   - ä¿®æ”¹æ ¸å¿ƒé…ç½®åè¦å…¨é¢éªŒè¯åŠŸèƒ½
   - æ—¥å¿—æ˜¯é—®é¢˜å®šä½çš„å…³é”®å·¥å…·

### 6.5 å›¾ç‰‡è·¯å¾„é—®é¢˜ä¿®å¤

#### é—®é¢˜å‘ç°ï¼šå¤§é‡å›¾ç‰‡404é”™è¯¯
åœ¨å‰ç«¯è®¿é—®å†å²é¡¹ç›®æ—¶å‘ç°å¤§é‡å›¾ç‰‡è¿”å›404é”™è¯¯ï¼š
```
INFO: 127.0.0.1:52080 - "GET /assets/slide_001_b28ca0192a914743a8241ca4467a66b2.jpg HTTP/1.1" 404 Not Found
INFO: 127.0.0.1:52101 - "GET /assets/slide_003_8b21d9ccfbb34592a3d713c4911b5df1.jpg HTTP/1.1" 404 Not Found
INFO: 127.0.0.1:52102 - "GET /assets/slide_002_020eed1272d64f41892858c2edf0e8cc.jpg HTTP/1.1" 404 Not Found
```

#### æ ¹æœ¬åŸå› åˆ†æ
æ‰¹é‡ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œå›¾ç‰‡æ–‡ä»¶è¢«ä¿å­˜åˆ°äº†é”™è¯¯çš„ä½ç½®ï¼š
- **å®é™…ä¿å­˜ä½ç½®**: `/Users/linyong/vscode/AIPPT/backend/backend/generated/images/`
- **é™æ€æ–‡ä»¶æŒ‚è½½ä½ç½®**: `/Users/linyong/vscode/AIPPT/backend/generated/images/`
- **å‰ç«¯è¯·æ±‚è·¯å¾„**: `/assets/slide_xxx.jpg`

è·¯å¾„ä¸åŒ¹é…å¯¼è‡´é™æ€æ–‡ä»¶æœåŠ¡æ— æ³•æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶ã€‚

#### é—®é¢˜è¿½æº¯
è·¯å¾„æ··ä¹±çš„æ ¹æºæ˜¯é…ç½®ä¿®æ”¹è¿‡ç¨‹ä¸­çš„ä¸ä¸€è‡´ï¼š
1. é…ç½®æ–‡ä»¶ä¸­è·¯å¾„ä»`backend/generated/images`ä¿®æ”¹ä¸º`generated/images`
2. æ‰¹é‡ç”Ÿæˆæ—¶å¯èƒ½ä½¿ç”¨äº†æ—§çš„é…ç½®æˆ–é”™è¯¯çš„ç›¸å¯¹è·¯å¾„
3. å¯¼è‡´å›¾ç‰‡è¢«ä¿å­˜åˆ°åŒé‡ç›®å½•ç»“æ„ä¸­

#### è§£å†³æ–¹æ¡ˆ
1. **å®šä½é”™è¯¯æ–‡ä»¶**ï¼š
   ```bash
   find /Users/linyong/vscode/AIPPT/backend -name "*slide_002_020eed1272d64f41892858c2edf0e8cc*"
   # ç»“æœ: /Users/linyong/vscode/AIPPT/backend/backend/generated/images/...
   ```

2. **æ‰¹é‡ç§»åŠ¨æ–‡ä»¶**ï¼š
   ```bash
   mv /Users/linyong/vscode/AIPPT/backend/backend/generated/images/*.jpg /Users/linyong/vscode/AIPPT/backend/generated/images/
   ```

3. **éªŒè¯ä¿®å¤ç»“æœ**ï¼š
   ```bash
   curl -I "http://localhost:8000/assets/slide_001_b28ca0192a914743a8241ca4467a66b2.jpg"
   # ç»“æœ: HTTP/1.1 200 OK
   ```

#### ä¿®å¤æˆæœ
- âœ… æ‰€æœ‰404çš„å›¾ç‰‡ç°åœ¨éƒ½èƒ½æ­£å¸¸è®¿é—®
- âœ… å‰ç«¯å†å²é¡¹ç›®å›¾ç‰‡æ¢å¤æ­£å¸¸æ˜¾ç¤º
- âœ… é™æ€æ–‡ä»¶æœåŠ¡é…ç½®æ­£ç¡®
- âœ… ç§»åŠ¨äº†100+ä¸ªå›¾ç‰‡æ–‡ä»¶åˆ°æ­£ç¡®ä½ç½®

### 6.6 å›¾ç‰‡å°ºå¯¸é—®é¢˜ï¼ˆå¾…è§£å†³ï¼‰

#### é—®é¢˜æè¿°
è™½ç„¶åç«¯æ—¥å¿—æ˜¾ç¤ºè¯·æ±‚å’Œç”Ÿæˆéƒ½ä¸º1920x1080ï¼Œä½†å®é™…ä¿å­˜çš„å›¾ç‰‡ä»ä¸º1376x768ã€‚

#### å·²å®Œæˆçš„ä¿®å¤
- âœ… ä¿®å¤`ImageGenerator._dimensions()`ä½¿ç”¨`DimensionCalculator`
- âœ… åç«¯æ—¥å¿—æ­£ç¡®æ˜¾ç¤ºï¼š`"width": 1920, "height": 1080`
- âœ… AI APIè¿”å›æ—¥å¿—ï¼š`Size: 1920x1080 | Path: Generated xxx bytes`

#### å¾…è°ƒæŸ¥çš„é—®é¢˜
- å®é™…å›¾ç‰‡æ–‡ä»¶ä»ä¸º1376x768ï¼ˆé€šè¿‡`file`å‘½ä»¤éªŒè¯ï¼‰
- å¯èƒ½æ˜¯OpenRouter/Gemini APIä¸æ”¯æŒè‡ªå®šä¹‰å°ºå¯¸å‚æ•°
- æˆ–è€…éœ€è¦ä¸åŒçš„å‚æ•°ä¼ é€’æ–¹å¼

#### ä¸´æ—¶çŠ¶æ€
åŠŸèƒ½æ­£å¸¸ï¼Œä½†å›¾ç‰‡å°ºå¯¸æœªè¾¾åˆ°é¢„æœŸã€‚éœ€è¦æŸ¥çœ‹OpenRouter APIæ–‡æ¡£ç¡®è®¤æ­£ç¡®çš„å°ºå¯¸å‚æ•°ä¼ é€’æ–¹å¼ã€‚

### çŠ¶æ€
âœ… **å·²å®Œæˆ** - é…ç½®ç³»ç»Ÿç»Ÿä¸€ï¼Œå›¾ç‰‡ç”ŸæˆåŠŸèƒ½æ­£å¸¸ï¼Œ404é—®é¢˜å·²è§£å†³
âš ï¸ **å¾…ä¼˜åŒ–** - å›¾ç‰‡å°ºå¯¸å‚æ•°ä¼ é€’éœ€è¦è¿›ä¸€æ­¥è°ƒæŸ¥